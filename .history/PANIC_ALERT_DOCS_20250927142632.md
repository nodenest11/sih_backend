# üöî Panic Alert to Police Dashboard Integration

## Overview
When a tourist sends a panic alert, the system automatically:
1. ‚úÖ **Saves the panic alert to database**
2. ‚úÖ **Sends alert data to police dashboard via API** 
3. ‚úÖ **Updates alert statistics and counts**
4. ‚úÖ **Tracks police notification status**

## API Endpoints

### 1. Create Panic Alert (Already exists, now enhanced)
```bash
POST /alerts/pressSOS
```

**Request Body:**
```json
{
  "tourist_id": 123,
  "latitude": 28.6139,
  "longitude": 77.2090,
  "message": "Emergency! Need help immediately!"
}
```

**What happens automatically:**
1. Creates alert in database with CRITICAL severity
2. Updates tourist safety score (-40 points)
3. **Sends alert to police dashboard API**
4. Marks alert as acknowledged by "Police Dashboard"

### 2. Get Alert Counts (NEW)
```bash
GET /alerts/counts
```

**Response:**
```json
{
  "summary": {
    "total_alerts": 25,
    "active_alerts": 8,
    "panic_sos_alerts": 5,
    "critical_alerts": 7,
    "today_alerts": 3,
    "police_notified": 5
  },
  "by_severity": {
    "LOW": 10,
    "MEDIUM": 8,
    "HIGH": 4,
    "CRITICAL": 3
  },
  "by_type": {
    "panic": 5,
    "geofence": 8,
    "anomaly": 7,
    "sos": 2
  },
  "by_status": {
    "active": 8,
    "resolved": 15,
    "acknowledged": 2
  }
}
```

### 3. Get Police Dashboard Status (NEW)
```bash
GET /alerts/police-status
```

**Response:**
```json
{
  "police_dashboard_status": {
    "total_sent_to_police": 5,
    "sent_today": 2,
    "last_sent": "2025-09-27T10:30:00"
  },
  "recent_police_alerts": [
    {
      "alert_id": 123,
      "tourist_id": 45,
      "severity": "CRITICAL",
      "message": "Emergency SOS",
      "sent_at": "2025-09-27T10:30:00",
      "location": "28.6139, 77.2090"
    }
  ]
}
```

### 4. Get All Alerts (Already exists)
```bash
GET /alerts/getAlerts
```

## Police Dashboard Integration

### Data Sent to Police API
When panic alert is created, this data is sent to police dashboard:

```json
{
  "emergency_type": "TOURIST_PANIC_ALERT",
  "alert_id": 123,
  "severity": "CRITICAL",
  "timestamp": "2025-09-27T10:30:00",
  "location": {
    "latitude": 28.6139,
    "longitude": 77.2090,
    "coordinates": "28.6139, 77.2090"
  },
  "tourist_info": {
    "id": 123,
    "name": "John Doe",
    "contact": "+919876543210",
    "age": 30,
    "nationality": "American",
    "emergency_contact": "+919876543211",
    "safety_score": 25
  },
  "alert_details": {
    "message": "Emergency! Need help immediately!",
    "type": "panic",
    "auto_generated": false
  },
  "response_required": true,
  "priority": "CRITICAL"
}
```

### Configuration
Add to your `.env` file:

```bash
# Police Dashboard Integration
POLICE_DASHBOARD_URL=http://police-api.example.com/emergency-alerts
POLICE_API_KEY=your-police-api-key-here
```

## Complete Flow Example

### 1. Tourist Presses Panic Button
```bash
curl -X POST http://localhost:8000/alerts/pressSOS \
  -H "Content-Type: application/json" \
  -d '{
    "tourist_id": 123,
    "latitude": 28.6139,
    "longitude": 77.2090,
    "message": "Help! I am in danger!"
  }'
```

### 2. System Response
```json
{
  "id": 456,
  "tourist_id": 123,
  "type": "panic",
  "severity": "CRITICAL",
  "message": "üÜò EMERGENCY SOS: Help! I am in danger!",
  "latitude": 28.6139,
  "longitude": 77.2090,
  "acknowledged": true,
  "acknowledged_by": "Police Dashboard",
  "status": "acknowledged"
}
```

### 3. Check Statistics
```bash
curl http://localhost:8000/alerts/counts
```

### 4. Check Police Status
```bash
curl http://localhost:8000/alerts/police-status
```

## Error Handling

### Police API Errors
If police dashboard API fails:
- ‚ùå Alert is still saved in database
- ‚ùå Tourist safety score is still updated  
- ‚ö†Ô∏è Error is logged but doesn't stop the process
- ‚ö†Ô∏è Alert won't be marked as "acknowledged by police"

### Timeout Protection
- Police API calls timeout after 10 seconds
- System continues even if police API is down
- Errors are logged for monitoring

## Testing

Run the test script:
```bash
python test_panic_system.py
```

This will:
1. Register a test tourist
2. Create a panic alert
3. Show alert counts and statistics  
4. Display police dashboard status
5. List all active alerts

## Benefits

### For Tourists
- ‚úÖ One-click emergency response
- ‚úÖ Automatic police notification
- ‚úÖ No additional steps required

### For Police
- ‚úÖ Immediate alert notifications
- ‚úÖ Complete tourist information
- ‚úÖ Precise GPS coordinates
- ‚úÖ Emergency context and details

### For System Admins
- ‚úÖ Real-time statistics
- ‚úÖ Police notification tracking
- ‚úÖ Error monitoring and logging
- ‚úÖ Comprehensive alert management